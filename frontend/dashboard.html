<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOI's Proxy - AI Proxy Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="dashboard.css">
    <!-- Chart.js for usage charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Access Code Modal -->
    <div class="access-overlay" id="accessCodeOverlay">
        <div class="access-card">
            <div class="access-icon">üîê</div>
            <h2 class="access-title">Admin Access Required</h2>
            <p class="access-subtitle">Enter the admin password to continue</p>
            <input type="password" id="accessCodeInput" class="access-input" placeholder="Admin Password"
                autocomplete="new-password" data-lpignore="true" data-form-type="other">
            <p class="access-code-error" id="accessCodeError"></p>
            <button class="access-btn" onclick="verifyAccessCode()">
                üîì Unlock Dashboard
            </button>
        </div>
    </div>

    <!-- Background Effects -->
    <div class="background-overlay"></div>
    <div class="background-grid"></div>

    <div class="container">
        <header class="glass-card">
            <div class="header-content">
                <h1>üöÄ MOI's Proxy</h1>
                <p class="subtitle">AI Proxy Control Center</p>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-label">Status</span>
                    <span class="status-indicator" id="wsStatus" onclick="reconnectWebSocket()" style="cursor: pointer;" title="Click to reconnect">
                        <span class="dot"></span>
                        <span id="wsStatusText">Connecting...</span>
                    </span>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="openGlobalSettingsModal()" title="Global Settings">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </header>

        <div class="main-content">
            <!-- API Key Management Section -->
            <section class="glass-card">
                <div class="section-header">
                    <div class="header-left">
                        <h2><span class="icon">üîë</span> API Key Management</h2>
                        <span class="key-count" id="keyCount">0 keys</span>
                    </div>
                    <div class="header-actions">
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="keySearch" placeholder="Search keys..." oninput="filterKeys()">
                        </div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all" onclick="setFilter('all', event)">All</button>
                            <button class="filter-btn" data-filter="active"
                                onclick="setFilter('active', event)">Active</button>
                            <button class="filter-btn" data-filter="disabled"
                                onclick="setFilter('disabled', event)">Disabled</button>
                        </div>
                        <button class="btn btn-warning" onclick="cleanupTestKeys()" title="Delete test API keys (names containing test, demo, sample, etc.)">
                            üßπ Cleanup Test Keys
                        </button>
                        <button class="btn btn-primary" id="btnGenerateKey">
                            <span>+</span> Generate Key
                        </button>
                    </div>
                </div>

                <div class="keys-container" id="keysContainer">
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p class="loading-text">Loading keys...</p>
                    </div>
                </div>
            </section>

            <!-- Analytics Dashboard Section -->
            <section class="glass-card">
                <div class="section-header">
                    <h2><span class="icon">üìä</span> Analytics Dashboard</h2>
                    <button class="btn btn-secondary" onclick="refreshAnalytics()">
                        üîÑ Refresh
                    </button>
                </div>

                <div class="analytics-container" id="analyticsContainer">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-icon">üìà</div>
                            <div class="analytics-value" id="totalRequests">0</div>
                            <div class="analytics-label">Total Requests</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">üî§</div>
                            <div class="analytics-value" id="totalInputTokens">0</div>
                            <div class="analytics-label">Input Tokens</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">üìù</div>
                            <div class="analytics-value" id="totalOutputTokens">0</div>
                            <div class="analytics-label">Output Tokens</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">üí∞</div>
                            <div class="analytics-value" id="totalCost">$0.00</div>
                            <div class="analytics-label">Total Cost</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">üî¢</div>
                            <div class="analytics-value" id="totalTokens">0</div>
                            <div class="analytics-label">Total Tokens</div>
                        </div>
                    </div>

                    <!-- Usage Charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Requests Over Time</h3>
                                <div class="chart-period">
                                    <button class="period-btn active" data-period="hourly"
                                        onclick="setChartPeriod('hourly')">24H</button>
                                    <button class="period-btn" data-period="daily"
                                        onclick="setChartPeriod('daily')">7D</button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="requestsChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Tokens Usage</h3>
                                <div class="chart-period">
                                    <button class="period-btn active" data-period="hourly"
                                        onclick="setTokenChartPeriod('hourly')">24H</button>
                                    <button class="period-btn" data-period="daily"
                                        onclick="setTokenChartPeriod('daily')">7D</button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="tokensChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="models-section">
                        <h3>ü§ñ Model Usage</h3>
                        <div class="models-list" id="modelsList">
                            <p class="loading-text">Loading model statistics...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Model Cost Management Section -->
            <section class="glass-card">
                <div class="section-header">
                    <div class="header-left">
                        <h2><span class="icon">üè∑Ô∏è</span> Model Cost Management</h2>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="showAddCostModal()">
                        <span>+</span> Add Model Cost
                    </button>
                </div>

                <div class="table-container model-costs-table" style="max-height: 400px; overflow-y: auto;">
                    <table class="request-table">
                        <thead>
                            <tr>
                                <th>Model Pattern</th>
                                <th>Input Cost ($/1M)</th>
                                <th>Output Cost ($/1M)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="modelCostsTableBody">
                            <tr>
                                <td colspan="4" class="loading-text text-center">Loading model costs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Client App Statistics Section -->
            <section class="glass-card">
                <div class="section-header">
                    <div class="header-left">
                        <h2><span class="icon">üì±</span> Client App Statistics</h2>
                        <span class="client-stats-period" id="clientStatsPeriod">Last 30 days</span>
                    </div>
                    <button class="btn btn-secondary" onclick="loadClientStats()">
                        üîÑ Refresh
                    </button>
                </div>

                <div class="client-stats-grid" id="clientStatsGrid">
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p class="loading-text">Loading client statistics...</p>
                    </div>
                </div>
            </section>

            <!-- Top Discord Users by Token Usage Section -->
            <section class="glass-card">
                <div class="section-header">
                    <div class="header-left">
                        <h2><span class="icon">üë•</span> Top Discord Users by Token Usage</h2>
                        <span class="discord-users-period" id="discordUsersPeriod">Top 10 - Last 30 days</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-warning" onclick="cleanupTestUsers()" title="Delete test Discord users (IDs with repeated digits)">
                            üßπ Cleanup Test Users
                        </button>
                        <button class="btn btn-secondary" onclick="loadTopDiscordUsers()">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>

                <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                    <table class="request-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Discord User</th>
                                <th>Total Tokens</th>
                                <th>Requests</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="topDiscordUsersTableBody">
                            <tr>
                                <td colspan="5" class="loading-text text-center">Loading top Discord users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Discord Ban Management Section -->
            <section class="glass-card">
                <div class="section-header">
                    <div class="header-left">
                        <h2><span class="icon">üö´</span> Discord Ban Management</h2>
                        <span class="discord-ban-count" id="discordBanCount">0 banned</span>
                    </div>
                    <button class="btn btn-secondary" onclick="loadBannedDiscordUsers()">
                        üîÑ Refresh
                    </button>
                </div>

                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table class="request-table">
                        <thead>
                            <tr>
                                <th>Discord User</th>
                                <th>Reason</th>
                                <th>Banned At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bannedDiscordTableBody">
                            <tr>
                                <td colspan="4" class="loading-text text-center">Loading banned users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Client Blacklist Management Section -->
            <section class="glass-card">
                <div class="section-header">
                    <div class="header-left">
                        <h2><span class="icon">üö´</span> Client Blacklist</h2>
                        <span class="blacklist-count" id="blacklistCount">0 blocked</span>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="showAddBlacklistModal()">
                        <span>+</span> Block Client
                    </button>
                </div>

                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                    <table class="request-table">
                        <thead>
                            <tr>
                                <th>Client App</th>
                                <th>Reason</th>
                                <th>Blocked At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="blacklistTableBody">
                            <tr>
                                <td colspan="4" class="loading-text text-center">Loading blacklist...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Announcements Management Section -->
            <section class="glass-card">
                <div class="section-header">
                    <div class="header-left">
                        <h2><span class="icon">üì¢</span> Announcements</h2>
                        <span class="announcement-count" id="announcementCount">0 announcements</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="loadAnnouncements()">
                            üîÑ Refresh
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="showCreateAnnouncementModal()">
                            <span>+</span> Create Announcement
                        </button>
                    </div>
                </div>

                <div class="announcements-list" id="announcementsList">
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p class="loading-text">Loading announcements...</p>
                    </div>
                </div>
            </section>

            <!-- Live Request Log Section -->
            <section class="glass-card">
                <div class="section-header">
                    <h2><span class="icon">üìã</span> Live Request Log</h2>
                    <span class="auto-refresh-badge">
                        <span class="dot"></span>
                        Auto-refresh: 3s
                    </span>
                </div>

                <div class="table-container" id="requestLogContainer">
                    <table class="request-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Model</th>
                                <th>Input Tokens</th>
                                <th>Output Tokens</th>
                                <th>Total</th>
                                <th>Cost</th>
                                <th>Client App</th>
                                <th>Client IP</th>
                            </tr>
                        </thead>
                        <tbody id="requestLogBody">
                            <tr>
                                <td colspan="9" class="loading-text text-center">Loading recent requests...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Large Context Requests Section (Collapsible) -->
            <section class="glass-card collapsible-section collapsed" id="largeContextSection">
                <div class="section-header collapsible-header" onclick="toggleLargeContextSection()">
                    <div class="header-left">
                        <h2><span class="icon">üìä</span> Large Context Requests</h2>
                        <span class="context-count" id="largeContextCount">0 requests</span>
                        <span class="context-threshold">(&gt;40k tokens)</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary btn-sm"
                            onclick="event.stopPropagation(); loadLargeContextLogs()">
                            üîÑ Refresh
                        </button>
                        <span class="collapse-icon" id="largeContextCollapseIcon">‚ñº</span>
                    </div>
                </div>

                <div class="collapsible-content" id="largeContextContent">
                    <!-- Stats Cards -->
                    <div class="large-context-stats" id="largeContextStats">
                        <div class="stat-card">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-value" id="lcTotalRequests">0</div>
                            <div class="stat-label">Total Requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-value" id="lcAvgTokens">0</div>
                            <div class="stat-label">Avg Tokens/Request</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üîù</div>
                            <div class="stat-value" id="lcMaxTokens">0</div>
                            <div class="stat-label">Max Tokens</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üî¢</div>
                            <div class="stat-value" id="lcTotalTokens">0</div>
                            <div class="stat-label">Total Tokens</div>
                        </div>
                    </div>

                    <!-- Logs Table -->
                    <div class="table-container" id="largeContextLogContainer">
                        <table class="request-table large-context-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>API Key</th>
                                    <th>Model</th>
                                    <th>Input</th>
                                    <th>Output</th>
                                    <th>Total</th>
                                    <th>Client IP</th>
                                </tr>
                            </thead>
                            <tbody id="largeContextTableBody">
                                <tr>
                                    <td colspan="7" class="loading-text text-center">Click to expand and load large
                                        context requests...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Data Management Section -->
            <section class="glass-card">
                <div class="section-header">
                    <h2><span class="icon">üíæ</span> Data Management</h2>
                </div>
                <div class="form-group" style="padding: 0 1rem 1rem;">
                    <p class="form-hint" style="margin-bottom: 1rem;">Backup or restore the entire database (API keys,
                        logs, costs).</p>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="exportData()">
                            ‚¨áÔ∏è Download Backup
                        </button>
                        <label class="btn btn-secondary" style="cursor: pointer; position: relative;">
                            ‚¨ÜÔ∏è Upload Restore File
                            <input type="file" id="importFile" onchange="importData(this)" style="display: none;"
                                accept=".json">
                        </label>
                    </div>
                </div>
            </section>

            <!-- Real-time Console Section -->
            <section class="glass-card">
                <div class="console-container">
                    <div class="console-header">
                        <div class="console-dots">
                            <span class="red"></span>
                            <span class="yellow"></span>
                            <span class="green"></span>
                        </div>
                        <span class="console-title">üìü Real-time Console</span>
                        <button class="btn btn-secondary btn-icon" onclick="clearConsole()" title="Clear Console">
                            üóëÔ∏è
                        </button>
                    </div>

                    <div class="console-output" id="console">
                        <div class="console-line">
                            <span class="time">[--:--:--]</span>
                            <span class="level info">INFO</span>
                            <span class="message">Initializing console...</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Generate API Key Modal -->
    <div class="modal-overlay" id="generateModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3>üîë Generate New API Key</h3>
                <button class="modal-close" onclick="closeGenerateModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="keyName">Key Name <span class="optional">(Optional)</span></label>
                    <input type="text" id="keyName" class="form-input" placeholder="e.g., Production API Key">
                </div>

                <div class="form-group">
                    <label class="form-label" for="claimCode">Claim Code <span class="optional">(Optional)</span></label>
                    <input type="text" id="claimCode" class="form-input mono" placeholder="e.g., MYCODE2024">
                    <p class="form-hint">Users enter this code to claim a sub-key. Leave empty to disable code-based claiming.</p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="maxRpm">Max RPM</label>
                        <input type="number" id="maxRpm" class="form-input" value="60" min="1" max="1000">
                        <p class="form-hint">Requests per minute</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="maxRpd">Max RPD</label>
                        <input type="number" id="maxRpd" class="form-input" value="1000" min="1" max="100000">
                        <p class="form-hint">Requests per day</p>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="maxTotalTokens">Token Quota (Total)</label>
                        <input type="number" id="maxTotalTokens" class="form-input" placeholder="e.g., 1000000">
                        <p class="form-hint">Hard limit on total tokens. Leave empty for unlimited.</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="maxContextTokens">Context Limit (Per Request)</label>
                        <input type="number" id="maxContextTokens" class="form-input" placeholder="e.g., 128000">
                        <p class="form-hint">Max tokens allowed per individual request.</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="targetUrl">Custom Target URL <span
                            class="optional">(Optional)</span></label>
                    <input type="text" id="targetUrl" class="form-input mono" placeholder="https://api.openai.com/v1">
                    <p class="form-hint">Leave empty to use default target URL</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="targetApiKey">Custom Target API Key <span
                            class="optional">(Optional)</span></label>
                    <input type="text" id="targetApiKey" class="form-input mono" placeholder="sk-...">
                    <p class="form-hint">Leave empty to use default API key</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="httpReferer">HTTP-Referer Header <span
                            class="optional">(Optional)</span></label>
                    <input type="text" id="httpReferer" class="form-input mono" placeholder="https://your-site.com">
                    <p class="form-hint">Custom HTTP-Referer header for OpenRouter compatibility (e.g.,
                        https://your-app.com)</p>
                </div>

                <div class="form-divider"></div>
                <h4 class="form-section-title">üîÄ Multi-Provider Configuration</h4>
                <p class="form-hint" style="margin-bottom: 16px;">Configure multiple providers for load balancing and
                    failover. When providers are configured, they override the single target URL/API key above.</p>

                <div class="form-group">
                    <div class="providers-header">
                        <label class="form-label">Providers <span class="optional">(Optional)</span></label>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addProvider()">+ Add
                            Provider</button>
                    </div>
                    <div id="providersContainer" class="providers-container">
                        <!-- Provider rows will be added here dynamically -->
                    </div>
                    <p class="form-hint">Add multiple providers for automatic rotation. Each provider needs a name, URL,
                        and API key.</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="providerRotationFrequency">Provider Rotation Frequency</label>
                    <div class="slider-container">
                        <input type="range" id="providerRotationFrequency" class="form-slider" min="1" max="100"
                            value="1" oninput="updateRotationFrequencyLabel(this.value)">
                        <span id="rotationFrequencyLabel" class="slider-value">1 request(s)</span>
                    </div>
                    <p class="form-hint">Number of requests before switching to the next provider</p>
                </div>

                <div class="form-divider"></div>
                <h4 class="form-section-title">üõ°Ô∏è Security & Access Control</h4>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label checkbox-label">
                            <input type="checkbox" id="noAuth" class="form-checkbox">
                            <span>No API Key (Don't send Authorization header)</span>
                        </label>
                        <p class="form-hint">Enable for providers that don't require authentication</p>
                    </div>


                </div>

                <div class="form-group">
                    <label class="form-label checkbox-label">
                        <input type="checkbox" id="disableModelFetch" class="form-checkbox">
                        <span>üö´ Disable Model Fetching</span>
                    </label>
                    <p class="form-hint">Prevent users from listing available models with this key</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="expiresAt">Key Expiration <span
                            class="optional">(Optional)</span></label>
                    <input type="datetime-local" id="expiresAt" class="form-input">
                    <p class="form-hint">Leave empty for no expiration</p>
                </div>

                <!-- IP Whitelist/Blacklist removed - Discord-based access control is now used -->

                <div class="form-group">
                    <label class="form-label" for="customPrefills">Custom Prefills <span
                            class="optional">(Optional)</span></label>
                    <textarea id="customPrefills" class="form-input form-textarea mono" rows="3"
                        placeholder='{"gpt-4": "Helpful assistant...", "default": "You are a helpful AI."}'></textarea>
                    <p class="form-hint">JSON mapping of model patterns to prefill text. Applied automatically.</p>
                </div>

                <div class="form-divider"></div>
                <h4 class="form-section-title">üîÑ Model Mapping</h4>

                <div class="form-group">
                    <label class="form-label">Model Aliases <span class="optional">(Optional)</span></label>
                    <div id="modelMappingsBuilder" class="model-mappings-builder">
                        <!-- Dynamic model mapping entries will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addModelMapping()"
                        style="margin-top: 8px;">+ Add Model Alias</button>
                    <p class="form-hint" style="margin-top: 8px;">Map alias names to real model names. For per-provider
                        mappings, add provider-specific entries.</p>

                    <details style="margin-top: 12px;">
                        <summary style="cursor: pointer; color: var(--text-secondary);">üìù Advanced: Edit Raw JSON
                        </summary>
                        <div class="model-mappings-container" style="margin-top: 8px;">
                            <textarea id="modelMappings" class="form-input form-textarea mono" rows="4"
                                placeholder='{"gpt-4": "gpt-4-turbo-preview", "claude": {"OpenAI": "gpt-4", "Anthropic": "claude-3-opus", "default": "gpt-4"}}'></textarea>
                            <button type="button" class="btn btn-icon btn-copy-mappings" onclick="copyModelMappings()"
                                title="Copy JSON">üìã</button>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="syncMappingsFromJson()"
                            style="margin-top: 4px;">‚Üë Load from JSON</button>
                        <button type="button" class="btn btn-secondary" onclick="syncMappingsToJson()"
                            style="margin-top: 4px; margin-left: 4px;">‚Üì Save to JSON</button>
                    </details>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGenerateModal()">Cancel</button>
                <button class="btn btn-primary" onclick="generateKey()">Generate Key</button>
            </div>
        </div>
    </div>

    <!-- Key Display Modal -->
    <div class="modal-overlay" id="keyDisplayModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚úÖ API Key Generated</h3>
                <button class="modal-close" onclick="closeKeyDisplayModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="key-display-container">
                    <div class="key-display-icon">üéâ</div>
                    <h4 class="key-display-title">Your API Key is Ready!</h4>
                    <p class="key-display-subtitle">Copy and save it somewhere safe</p>
                    <div class="key-display-value" id="generatedKey"></div>
                    <div class="key-display-warning">
                        <span class="icon">‚ö†Ô∏è</span>
                        <span>This key will only be shown once. Make sure to copy it now!</span>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeKeyDisplayModal()">Close</button>
                <button class="btn btn-primary" onclick="copyKey()">üìã Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Edit Limits Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3>‚öôÔ∏è Edit API Key Settings</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="editClaimCode">Claim Code <span class="optional">(Optional)</span></label>
                    <input type="text" id="editClaimCode" class="form-input mono" placeholder="e.g., MYCODE2024">
                    <p class="form-hint">Users enter this code to claim a sub-key. Leave empty to disable code-based claiming.</p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="editMaxRpm">Max RPM</label>
                        <input type="number" id="editMaxRpm" class="form-input" min="1" max="1000">
                        <p class="form-hint">Requests per minute</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editMaxRpd">Max RPD</label>
                        <input type="number" id="editMaxRpd" class="form-input" min="1" max="100000">
                        <p class="form-hint">Requests per day</p>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="editMaxTotalTokens">Token Quota (Total)</label>
                        <input type="number" id="editMaxTotalTokens" class="form-input" placeholder="No limit">
                        <p class="form-hint">Hard limit on total tokens.</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editMaxContextTokens">Context Limit</label>
                        <input type="number" id="editMaxContextTokens" class="form-input" placeholder="No limit">
                        <p class="form-hint">Max tokens per request.</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTargetUrl">Custom Target URL <span
                            class="optional">(Optional)</span></label>
                    <input type="text" id="editTargetUrl" class="form-input mono"
                        placeholder="https://api.openai.com/v1">
                    <p class="form-hint">Leave empty to use default target URL</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editTargetApiKey">Custom Target API Key <span
                            class="optional">(Optional)</span></label>
                    <input type="text" id="editTargetApiKey" class="form-input mono" placeholder="sk-...">
                    <p class="form-hint">Leave empty to use default API key</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editHttpReferer">HTTP-Referer Header <span
                            class="optional">(Optional)</span></label>
                    <input type="text" id="editHttpReferer" class="form-input mono" placeholder="https://your-site.com">
                    <p class="form-hint">Custom HTTP-Referer header for OpenRouter compatibility (e.g.,
                        https://your-app.com)</p>
                </div>

                <div class="form-divider"></div>
                <h4 class="form-section-title">üîÄ Multi-Provider Configuration</h4>
                <p class="form-hint" style="margin-bottom: 16px;">Configure multiple providers for load balancing and
                    failover. When providers are configured, they override the single target URL/API key above.</p>

                <div class="form-group">
                    <div class="providers-header">
                        <label class="form-label">Providers <span class="optional">(Optional)</span></label>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addEditProvider()">+ Add
                            Provider</button>
                    </div>
                    <div id="editProvidersContainer" class="providers-container">
                        <!-- Provider rows will be added here dynamically -->
                    </div>
                    <p class="form-hint">Add multiple providers for automatic rotation. Each provider needs a name, URL,
                        and API key.</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editProviderRotationFrequency">Provider Rotation Frequency</label>
                    <div class="slider-container">
                        <input type="range" id="editProviderRotationFrequency" class="form-slider" min="1" max="100"
                            value="1" oninput="updateEditRotationFrequencyLabel(this.value)">
                        <span id="editRotationFrequencyLabel" class="slider-value">1 request(s)</span>
                    </div>
                    <p class="form-hint">Number of requests before switching to the next provider</p>
                </div>

                <div class="form-divider"></div>
                <h4 class="form-section-title">üõ°Ô∏è Security & Access Control</h4>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label checkbox-label">
                            <input type="checkbox" id="editNoAuth" class="form-checkbox">
                            <span>No API Key (Don't send Authorization header)</span>
                        </label>
                        <p class="form-hint">Enable for providers that don't require authentication</p>
                    </div>


                </div>

                <div class="form-group">
                    <label class="form-label checkbox-label">
                        <input type="checkbox" id="editDisableModelFetch" class="form-checkbox">
                        <span>üö´ Disable Model Fetching</span>
                    </label>
                    <p class="form-hint">Prevent users from listing available models with this key</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editExpiresAt">Key Expiration <span
                            class="optional">(Optional)</span></label>
                    <input type="datetime-local" id="editExpiresAt" class="form-input">
                    <p class="form-hint">Leave empty for no expiration</p>
                </div>

                <!-- IP Whitelist/Blacklist removed - Discord-based access control is now used -->

                <div class="form-group">
                    <label class="form-label" for="editCustomPrefills">Custom Prefills <span
                            class="optional">(Optional)</span></label>
                    <textarea id="editCustomPrefills" class="form-input form-textarea mono" rows="3"
                        placeholder='{"gpt-4": "Helpful assistant...", "default": "You are a helpful AI."}'></textarea>
                    <p class="form-hint">JSON mapping of model patterns to prefill text.</p>
                </div>

                <div class="form-divider"></div>
                <h4 class="form-section-title">üîÑ Model Mapping</h4>

                <div class="form-group">
                    <label class="form-label">Model Aliases <span class="optional">(Optional)</span></label>
                    <div id="editModelMappingsBuilder" class="model-mappings-builder">
                        <!-- Dynamic model mapping entries will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addEditModelMapping()"
                        style="margin-top: 8px;">+ Add Model Alias</button>
                    <p class="form-hint" style="margin-top: 8px;">Map alias names to real model names. For per-provider
                        mappings, add provider-specific entries.</p>

                    <details style="margin-top: 12px;">
                        <summary style="cursor: pointer; color: var(--text-secondary);">üìù Advanced: Edit Raw JSON
                        </summary>
                        <div class="model-mappings-container" style="margin-top: 8px;">
                            <textarea id="editModelMappings" class="form-input form-textarea mono" rows="4"
                                placeholder='{"gpt-4": "gpt-4-turbo-preview", "claude": {"OpenAI": "gpt-4", "Anthropic": "claude-3-opus", "default": "gpt-4"}}'></textarea>
                            <button type="button" class="btn btn-icon btn-copy-mappings"
                                onclick="copyEditModelMappings()" title="Copy JSON">üìã</button>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="syncEditMappingsFromJson()"
                            style="margin-top: 4px;">‚Üë Load from JSON</button>
                        <button type="button" class="btn btn-secondary" onclick="syncEditMappingsToJson()"
                            style="margin-top: 4px; margin-left: 4px;">‚Üì Save to JSON</button>
                    </details>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdits()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Schedule Refresh Modal -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚è∞ Schedule Auto-Refresh</h3>
                <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="refreshHour">Refresh Hour (24-hour format)</label>
                    <input type="number" id="refreshHour" class="form-input" value="0" min="0" max="23"
                        placeholder="0-23">
                    <p class="form-hint">Rate limits will reset daily at this hour (UTC)</p>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSchedule()">Set Schedule</button>
            </div>
        </div>
    </div>

    <!-- Model Cost Modal -->
    <div class="modal-overlay" id="costModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üè∑Ô∏è Add/Edit Model Cost</h3>
                <button class="modal-close" onclick="closeCostModal()">&times;</button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="costId">
                <div class="form-group">
                    <label class="form-label" for="modelPattern">Model Pattern (e.g., gpt-4*)</label>
                    <input type="text" id="modelPattern" class="form-input mono" placeholder="gpt-4o">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="inputCost">Input Cost ($/1M tokens)</label>
                        <input type="number" id="inputCost" class="form-input" step="0.01" value="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="outputCost">Output Cost ($/1M tokens)</label>
                        <input type="number" id="outputCost" class="form-input" step="0.01" value="0.00">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCostModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveModelCost()">Save Cost</button>
            </div>
        </div>
    </div>

    <!-- Add to Blacklist Modal -->
    <div class="modal-overlay" id="blacklistModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üö´ Block Client App</h3>
                <button class="modal-close" onclick="closeBlacklistModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="blacklistClientApp">Client App Name</label>
                    <input type="text" id="blacklistClientApp" class="form-input" placeholder="e.g., Janitor AI">
                    <p class="form-hint">Enter the exact client app name to block</p>
                </div>
                <div class="form-group">
                    <label class="form-label" for="blacklistReason">Reason <span class="optional">(Optional)</span></label>
                    <input type="text" id="blacklistReason" class="form-input" placeholder="e.g., Abuse detected">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBlacklistModal()">Cancel</button>
                <button class="btn btn-danger" onclick="addToBlacklist()">üö´ Block Client</button>
            </div>
        </div>
    </div>

    <!-- Ban Discord User Modal -->
    <div class="modal-overlay" id="discordBanModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üö´ Ban Discord User</h3>
                <button class="modal-close" onclick="closeDiscordBanModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="banDiscordId">Discord User ID</label>
                    <input type="text" id="banDiscordId" class="form-input mono" placeholder="e.g., 123456789012345678" readonly>
                    <p class="form-hint">The Discord user ID to ban</p>
                </div>
                <div class="form-group">
                    <label class="form-label" for="banDiscordUsername">Username</label>
                    <input type="text" id="banDiscordUsername" class="form-input" placeholder="Username" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="banDiscordReason">Reason <span class="optional">(Optional)</span></label>
                    <input type="text" id="banDiscordReason" class="form-input" placeholder="e.g., Abuse detected">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDiscordBanModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmBanDiscordUser()">üö´ Ban User</button>
            </div>
        </div>
    </div>

    <!-- Sub-Key User Details Modal -->
    <div class="modal-overlay" id="userDetailsModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3>üë§ User Details</h3>
                <button class="modal-close" onclick="closeUserDetailsModal()">&times;</button>
            </div>

            <div class="modal-body">
                <!-- User Info Section -->
                <div class="user-details-header" id="userDetailsHeader">
                    <img class="user-details-avatar" id="userDetailsAvatar" src="" alt="User Avatar">
                    <div class="user-details-info">
                        <div class="user-details-username" id="userDetailsUsername">Loading...</div>
                        <div class="user-details-subkey" id="userDetailsSubKey"></div>
                        <div class="user-details-discord-id" id="userDetailsDiscordId"></div>
                    </div>
                    <div class="user-details-status" id="userDetailsStatus">
                        <span class="badge badge-enabled">Active</span>
                    </div>
                </div>

                <!-- Usage Stats Section -->
                <div class="user-details-stats" id="userDetailsStats">
                    <div class="user-stat-card">
                        <div class="user-stat-icon">üí∞</div>
                        <div class="user-stat-value" id="userDetailsDollarUsage">$0.00</div>
                        <div class="user-stat-label">Daily Usage</div>
                        <div class="user-stat-limit" id="userDetailsDollarLimit">of $20.00</div>
                    </div>
                    <div class="user-stat-card">
                        <div class="user-stat-icon">üìä</div>
                        <div class="user-stat-value" id="userDetailsTotalRequests">0</div>
                        <div class="user-stat-label">Total Requests</div>
                    </div>
                    <div class="user-stat-card">
                        <div class="user-stat-icon">üïê</div>
                        <div class="user-stat-value" id="userDetailsLastUsed">Never</div>
                        <div class="user-stat-label">Last Active</div>
                    </div>
                    <div class="user-stat-card">
                        <div class="user-stat-icon">üìÖ</div>
                        <div class="user-stat-value" id="userDetailsCreatedAt">-</div>
                        <div class="user-stat-label">Created</div>
                    </div>
                </div>

                <!-- Dollar Limit Editor -->
                <div class="user-details-limit-editor">
                    <label class="form-label">Daily Dollar Limit</label>
                    <div class="limit-editor-row">
                        <input type="number" id="userDetailsLimitInput" class="form-input" min="0" step="0.01" value="20.00">
                        <button class="btn btn-primary btn-sm" onclick="updateUserDollarLimit()">Update Limit</button>
                        <button class="btn btn-warning btn-sm" onclick="resetUserQuota()" title="Reset today's usage to $0.00">Reset Quota</button>
                    </div>
                </div>

                <!-- Usage Logs Section -->
                <div class="user-details-logs-section">
                    <div class="user-details-logs-header">
                        <h4>üìã Recent Usage Logs</h4>
                        <span class="user-details-logs-count" id="userDetailsLogsCount">(0 logs)</span>
                    </div>
                    <div class="user-details-logs-container" id="userDetailsLogsContainer">
                        <table class="request-table user-details-logs-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Model</th>
                                    <th>Input</th>
                                    <th>Output</th>
                                    <th>Total</th>
                                    <th>Client</th>
                                    <th>Cost</th>
                                </tr>
                            </thead>
                            <tbody id="userDetailsLogsBody">
                                <tr>
                                    <td colspan="7" class="loading-text text-center">Loading logs...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="user-details-logs-footer" id="userDetailsLogsFooter" style="display: none;">
                        <button class="btn btn-secondary btn-sm" id="loadMoreLogsBtn" onclick="loadMoreUserLogs()">
                            Load More Logs
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUserDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Global Settings Modal -->
    <div class="modal-overlay" id="globalSettingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>‚öôÔ∏è Global Settings</h3>
                <button class="modal-close" onclick="closeGlobalSettingsModal()">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Sub-Key Default Dollar Limit -->
                <div class="form-group">
                    <label class="form-label" for="globalDollarLimit">Default Daily Dollar Limit for Sub-Keys</label>
                    <p class="form-hint">This sets the default daily spending limit for all new sub-keys. Existing sub-keys will not be affected.</p>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input type="number" id="globalDollarLimit" class="form-input" min="0" step="0.01" value="20.00">
                    </div>
                </div>

                <!-- Apply to All Existing Sub-Keys -->
                <div class="form-group">
                    <label class="form-label">Apply to All Existing Sub-Keys</label>
                    <p class="form-hint">Update the daily dollar limit for ALL existing sub-keys at once.</p>
                    <div class="limit-editor-row">
                        <div class="input-with-prefix">
                            <span class="input-prefix">$</span>
                            <input type="number" id="bulkDollarLimit" class="form-input" min="0" step="0.01" value="20.00">
                        </div>
                        <button class="btn btn-warning" onclick="applyBulkDollarLimit()">Apply to All Sub-Keys</button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGlobalSettingsModal()">Close</button>
                <button class="btn btn-primary" onclick="saveGlobalSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Announcement Modal -->
    <div class="modal-overlay" id="announcementModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 id="announcementModalTitle">üì¢ Create Announcement</h3>
                <button class="modal-close" onclick="closeAnnouncementModal()">&times;</button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="announcementId">
                
                <div class="form-group">
                    <label class="form-label" for="announcementTitle">Title</label>
                    <input type="text" id="announcementTitle" class="form-input" placeholder="Announcement title">
                </div>

                <div class="form-group">
                    <label class="form-label" for="announcementContent">Content</label>
                    <textarea id="announcementContent" class="form-input form-textarea" rows="4" placeholder="Announcement content..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="announcementType">Type</label>
                        <select id="announcementType" class="form-input" onchange="togglePollOptions()">
                            <option value="info">üì¢ Info</option>
                            <option value="warning">‚ö†Ô∏è Warning</option>
                            <option value="error">üö® Error</option>
                            <option value="poll">üìä Poll</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="announcementExpiry">Expiry Date <span class="optional">(Optional)</span></label>
                        <input type="datetime-local" id="announcementExpiry" class="form-input">
                        <p class="form-hint">Leave empty for no expiration</p>
                    </div>
                </div>

                <div class="form-group" id="pollOptionsGroup" style="display: none;">
                    <label class="form-label">Poll Options</label>
                    <div id="pollOptionsContainer" class="poll-options-builder">
                        <!-- Poll options will be added here dynamically -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addPollOption()" style="margin-top: 8px;">
                        + Add Option
                    </button>
                    <p class="form-hint">Add at least 2 options for the poll</p>
                </div>

                <div class="form-divider"></div>
                <h4 class="form-section-title">üñºÔ∏è Media Attachment (Optional)</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="announcementMediaUrl">Media URL</label>
                        <input type="text" id="announcementMediaUrl" class="form-input mono" placeholder="https://example.com/image.png">
                        <p class="form-hint">URL to an image or audio file</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="announcementMediaType">Media Type</label>
                        <select id="announcementMediaType" class="form-input">
                            <option value="">None</option>
                            <option value="image">üñºÔ∏è Image</option>
                            <option value="audio">üîä Audio</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAnnouncementModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAnnouncement()">Save Announcement</button>
            </div>
        </div>
    </div>

    <script src="dashboard.js"></script>
</body>

</html>